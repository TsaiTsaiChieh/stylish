<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Checkout</title>
    <style>
        .tpfield {
            height: 40px;
            width: 300px;
            border: 1px solid gray;
            margin: 5px 0;
            padding: 5px;
        }

        /* Bootstrap 的 focus style */
        .tappay-field-focus {
            border-color: #66afe9;
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
        }

        input {
            margin-right: 10px;
            width: 20em;
            font-size: 1em;

            line-height: 1.5em;
        }

        .product_wrap {
            margin-bottom: 1.5em;
            display: flex;
            flex-direction: column;
            line-height: 2em;

        }

        button {
            font-size: 1.2em;
            width: 10em;
            margin: 1em 0;
            padding: .3em 0;
            /* border-radius: .5em; */
            color: #fff;
            background: #000;
            border: none;
        }

        .colors_wrap {
            font-size: 1em;
            display: flex;
            flex-direction: row;
            margin-top: 1em
        }

        .colors_wrap input {
            width: 7em;
        }
    </style>
    <script src="https://js.tappaysdk.com/tpdirect/v5.1.0"></script>
    <script>
        TPDirect.setupSDK(12348, 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF', 'sandbox');
    </script>
</head>


<body>
    <div style="width: 80%; margin: 50px auto;">
        <div class="product_wrap">
            <!-- <h3>填寫商品</h3>
            <label>Product id</label><input type="text" class='id'>
            <label>Name</label><input type="text" class='name'>
            <label>Price</label><input type="text" class='price'>
            <div class="colors_wrap">
                <label>Name</label><input type="text" class="color_name">
                <label>Code</label><input type="text" class="color_code">
            </div>
            <label>Size</label><input type="text" class='size'>
            <label>Qty</label><input type="text" class='qty'> -->
        </div>
        <HR>
        <div id="payment">
            <h3>付款資料</h3>
            <label>信用卡號碼
                <div class="tpfield" id="card-number"></div>
            </label>
            <label>
                有效期限
                <div class="tpfield" id="card-expiration-date"></div>
            </label>
            <label>
                安全碼
                <div class="tpfield" id="card-ccv"></div>
            </label>
        </div>
        <label>Token<input type="token" class="token"></label>
        <div class="message"></div>
        <!-- 觸發 GetPrime 的按鈕 -->
        <button id="submit-button" onclick="onClick()">確認付款
        </button>


    </div>

    <script>

        TPDirect.card.setup({
            fields: {
                number: {
                    // css selector
                    element: '#card-number',
                    placeholder: '**** **** **** ****'
                },
                expirationDate: {
                    // DOM object
                    element: document.getElementById('card-expiration-date'),
                    placeholder: 'MM / YY'
                },
                ccv: {
                    element: '#card-ccv',
                    placeholder: '後三碼'
                }
            },
            styles: {
                // Style all elements
                'input': {
                    'color': 'gray'
                },
                // Styling ccv field
                'input.cvc': {
                    // 'font-size': '16px'
                },
                // Styling expiration-date field
                'input.expiration-date': {
                    // 'font-size': '16px'
                },
                // Styling card-number field
                'input.card-number': {
                    // 'font-size': '16px'
                },
                // style focus state
                ':focus': {
                    // 'color': 'black'
                },
                // style valid state
                '.valid': {
                    'color': 'green'
                },
                // style invalid state
                '.invalid': {
                    'color': 'red'
                },
                // Media queries
                // Note that these apply to the iframe, not the root window.
                '@media screen and (max-width: 400px)': {
                    'input': {
                        'color': 'orange'
                    }
                }
            }
        });
        var submitButton = document.querySelector('#submit-button');

        TPDirect.card.onUpdate(function (update) {
            // update.canGetPrime === true
            // --> you can call TPDirect.card.getPrime()
            if (update.canGetPrime) {
                // Enable submit Button to get prime.
                submitButton.removeAttribute('disabled');
            } else {
                // Disable submit Button to get prime.
                submitButton.setAttribute('disabled', true);
            }

            // cardTypes = ['mastercard', 'visa', 'jcb', 'amex', 'unknown']
            // if (update.cardType === 'visa') {
            //     // Handle card type visa.
            // }

            // // number 欄位是錯誤的
            // if (update.status.number === 2) {
            //     // setNumberFormGroupToError()
            // } else if (update.status.number === 0) {
            //     // setNumberFormGroupToSuccess()
            // } else {
            //     // setNumberFormGroupToNormal()
            // }

            // if (update.status.expiry === 2) {
            //     // setNumberFormGroupToError()
            // } else if (update.status.expiry === 0) {
            //     // setNumberFormGroupToSuccess()
            // } else {
            //     // setNumberFormGroupToNormal()
            // }

            // if (update.status.cvc === 2) {
            //     // setNumberFormGroupToError()
            // } else if (update.status.cvc === 0) {
            //     // setNumberFormGroupToSuccess()
            // } else {
            //     // setNumberFormGroupToNormal()
            // }
        });

        function onClick() {
            // 讓 button click 之後觸發 getPrime 方法
            TPDirect.card.getPrime(function (result) {
                if (result.status !== 0) {
                    console.err('getPrime 錯誤')
                    return
                }

                const prime = result.card.prime;

                // get product list
                // var products = [];
                // var productList = document.getElementsByClassName('product');
                var subtotal = 1299;
                var freight = 60;
                var total = subtotal + freight;
                // for (let i = 0; i < productList.length; i++) {
                //     if (productList[i].checked) {
                //         products.push(productList[i].value);
                //         subtotal += parseInt(products[i].replace(/\s+/g, "").split(',')[1].replace('price:', ""));
                //     }
                // }
                // if (subtotal >= 1000) { // 我們一千免運!
                //     total = subtotal;
                // }
                // else {
                //     freight = 60;
                //     total = subtotal + freight;
                // }
                var recipient = {
                    name: '蔡采潔',
                    phone_number: '+886923456789',
                    email: 'jecica196@gmail.com',
                    address: '市政府站',
                    time: 'morning'
                };
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", "/api/1/order/checkout");
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                // set header 比較好測試
                // xmlhttp.setRequestHeader('Authorization', 'Bearer ' + '737f00dccc2e1088ba8d8fcd69a4252dc71eb87dfcaa8c5a3674ba9f99ee2f35');

                var list = [{
                    id: '3', name: '活力花紋長筒牛仔褲', price: 999,
                    color: {
                        code: 'DDF0FF', name: '淺藍'
                    },
                    size: 'M', qty: 1
                }];
                // var id = document.getElementsByClassName('id')[0].value;
                // var name = document.getElementsByClassName('name')[0].value;
                // var price = document.getElementsByClassName('price')[0].value;
                // var color_code = document.getElementsByClassName('color_code')[0].value;
                // var color_name = document.getElementsByClassName('color_name')[0].value;
                // var size = document.getElementsByClassName('size')[0].value;
                // var qty = document.getElementsByClassName('qty')[0].value;
                // var list = [{ id, name, color: { code: color_code, name: color_name }, size, qty }];
                const token = document.getElementsByClassName('token')[0].value;
                console.log(token);

                list = JSON.stringify(list);
                var order = { shipping: 'delivery', payment: 'credit_card', subtotal, freight, total, recipient, list };
                console.log(JSON.stringify({ prime, order }));
                xmlhttp.onreadystatechange = function () {

                    if (this.status === 404) {
                        // document.getElementsByClassName("message")[1].innerHTML = xmlhttp.responseText;
                        document.getElementsByClassName("message")[0].innerHTML = '無效 Token，請重新登入！';
                    }
                    else if (this.status === 400) {
                        document.getElementsByClassName("message")[0].innerHTML = '交易失敗！';
                    }
                    else if (this.status == 200) {
                        document.getElementsByClassName("message")[0].innerHTML = '交易成功';
                    }
                }
                xmlhttp.send(JSON.stringify({ prime, order, token }));
            })
        }

        function onSubmit(event) {
            event.preventDefault();

            // 取得 TapPay Fields 的 status
            const tappayStatus = TPDirect.card.getTappayFieldsStatus()

            // 確認是否可以 getPrime
            if (tappayStatus.canGetPrime === false) {
                alert('can not get prime')
                return
            }

            // Get prime
            TPDirect.card.getPrime((result) => {
                if (result.status !== 0) {
                    alert('get prime error ' + result.msg)
                    return
                }
                alert('get prime 成功，prime: ' + result.card.prime)

                // send prime to your server, to pay with Pay by Prime API .
                // Pay By Prime Docs: https://docs.tappaysdk.com/tutorial/zh/back.html#pay-by-prime-api
            })
        }
    </script>


</body>

</html>