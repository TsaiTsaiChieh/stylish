<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Checkout</title>
    <style>
        .tpfield {
            height: 40px;
            width: 300px;
            border: 1px solid gray;
            margin: 5px 0;
            padding: 5px;
        }

        /* Bootstrap 的 focus style */
        .tappay-field-focus {
            border-color: #66afe9;
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
        }
    </style>
    <script src="https://js.tappaysdk.com/tpdirect/v5.1.0"></script>
    <script>
        TPDirect.setupSDK(13956, 'app_OqEjgnXl8CB72AgdC67UKWzUAmEp7Su7tiweHIUMQwJ2S41NUYrcmYFwPH8C', 'sandbox');
    </script>
</head>


<body>

    <div style="width: 480px; margin: 50px auto;">
        <!-- <label>CardView</label> -->
        <!-- 表單 -->
        <div id="cardview-container">
            <label>visa 卡號
                <div class="tpfield" id="card-number"></div>
            </label>
            <label>
                卡片到期日
                <div class="tpfield" id="card-expiration-date"></div>
            </label>
            <label>
                卡片後三碼
                <div class="tpfield" id="card-ccv"></div>
            </label>
        </div>
        <!-- 觸發 GetPrime 的按鈕 -->
        <button id="submit-button" onclick="onClick()">Get Prime</button>
    </div>

    <script>

        TPDirect.card.setup({
            fields: {
                number: {
                    // css selector
                    element: '#card-number',
                    placeholder: '**** **** **** ****'
                },
                expirationDate: {
                    // DOM object
                    element: document.getElementById('card-expiration-date'),
                    placeholder: 'MM / YY'
                },
                ccv: {
                    element: '#card-ccv',
                    placeholder: '後三碼'
                }
            },
            styles: {
                // Style all elements
                'input': {
                    'color': 'gray'
                },
                // Styling ccv field
                'input.cvc': {
                    // 'font-size': '16px'
                },
                // Styling expiration-date field
                'input.expiration-date': {
                    // 'font-size': '16px'
                },
                // Styling card-number field
                'input.card-number': {
                    // 'font-size': '16px'
                },
                // style focus state
                ':focus': {
                    // 'color': 'black'
                },
                // style valid state
                '.valid': {
                    'color': 'green'
                },
                // style invalid state
                '.invalid': {
                    'color': 'red'
                },
                // Media queries
                // Note that these apply to the iframe, not the root window.
                '@media screen and (max-width: 400px)': {
                    'input': {
                        'color': 'orange'
                    }
                }
            }
        });
        var submitButton = document.querySelector('#submit-button');

        TPDirect.card.onUpdate(function (update) {
            // update.canGetPrime === true
            // --> you can call TPDirect.card.getPrime()
            if (update.canGetPrime) {
                // Enable submit Button to get prime.
                submitButton.removeAttribute('disabled');
            } else {
                // Disable submit Button to get prime.
                submitButton.setAttribute('disabled', true);
            }

            // cardTypes = ['mastercard', 'visa', 'jcb', 'amex', 'unknown']
            // if (update.cardType === 'visa') {
            //     // Handle card type visa.
            // }

            // // number 欄位是錯誤的
            // if (update.status.number === 2) {
            //     // setNumberFormGroupToError()
            // } else if (update.status.number === 0) {
            //     // setNumberFormGroupToSuccess()
            // } else {
            //     // setNumberFormGroupToNormal()
            // }

            // if (update.status.expiry === 2) {
            //     // setNumberFormGroupToError()
            // } else if (update.status.expiry === 0) {
            //     // setNumberFormGroupToSuccess()
            // } else {
            //     // setNumberFormGroupToNormal()
            // }

            // if (update.status.cvc === 2) {
            //     // setNumberFormGroupToError()
            // } else if (update.status.cvc === 0) {
            //     // setNumberFormGroupToSuccess()
            // } else {
            //     // setNumberFormGroupToNormal()
            // }
        });
        function onClick() {
            // 讓 button click 之後觸發 getPrime 方法
            TPDirect.card.getPrime(function (result) {
                if (result.status !== 0) {
                    console.err('getPrime 錯誤')
                    return false;
                }
                const prime = result.card.prime;
                alert('getPrime 成功: ' + prime);
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", "/api/1/order/checkout");
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xmlhttp.send(JSON.stringify({ prime }));
                console.log(prime);

            })
        }

        function onSubmit(event) {
            event.preventDefault();

            // 取得 TapPay Fields 的 status
            const tappayStatus = TPDirect.card.getTappayFieldsStatus()

            // 確認是否可以 getPrime
            if (tappayStatus.canGetPrime === false) {
                alert('can not get prime')
                return
            }

            // Get prime
            TPDirect.card.getPrime((result) => {
                if (result.status !== 0) {
                    alert('get prime error ' + result.msg)
                    return
                }
                alert('get prime 成功，prime: ' + result.card.prime)

                // send prime to your server, to pay with Pay by Prime API .
                // Pay By Prime Docs: https://docs.tappaysdk.com/tutorial/zh/back.html#pay-by-prime-api
            })
        }
    </script>


</body>

</html>